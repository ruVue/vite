# Миграция с v3

## Rollup 3

Vite теперь использует [Rollup 3](https://github.com/vitejs/vite/issues/9870), который позволил нам упростить внутреннюю обработку активов Vite и содержит множество улучшений. См. [примечания к выпуску Rollup 3 здесь](https://github.com/rollup/rollup/releases/tag/v3.0.0).

Rollup 3 в основном совместим с Rollup 2. Если вы используете в своем проекте собственные [`rollupOptions`](../config/build-options.md#rollup-options) и столкнулись с проблемами, обратитесь к [Руководству по миграции Rollup](https://rollupjs.org/migration/), чтобы обновить конфигурацию.

## Изменение базовой линии современного браузера

Современная сборка браузера теперь нацелена на `safari14` по умолчанию для более широкой совместимости с ES2020 (от `safari13`). Это означает, что современные сборки теперь могут использовать [`BigInt`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt) и что [нулевой оператор объединения](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Nullish_coalescing) больше не транспилируется. Если вам нужна поддержка старых браузеров, вы можете добавить [`@vitejs/plugin-legacy`](https://github.com/vitejs/vite/tree/main/packages/plugin-legacy) как обычно.

## Общие изменения

### Кодирование

Кодировка сборки по умолчанию теперь utf8 (подробности смотрите [#10753](https://github.com/vitejs/vite/issues/10753)).

### Импорт CSS в виде строки

В Vite 3 импорт экспортируемого по умолчанию файла `.css` может привести к двойной загрузке CSS.

```ts
import cssString from './global.css'
```

Эта двойная загрузка может произойти, поскольку будет создан файл `.css`, и вполне вероятно, что строка CSS также будет использоваться кодом приложения — например, внедренная средой выполнения фреймворка. Начиная с Vite 4, экспорт по умолчанию `.css` [устарел](https://github.com/vitejs/vite/issues/11094). В этом случае необходимо использовать модификатор суффикса запроса `?inline`, так как он не создает импортированные стили `.css`.

```ts
import stuff from './global.css?inline'
```

### Производственные сборки по умолчанию

`vite build` теперь всегда будет собираться для производства, независимо от переданного `--mode`. Раньше изменение `mode` на любой другой, кроме `production`, приводило к сборке для разработки. Если вы все еще хотите собирать для разработки, вы можете установить `NODE_ENV=development` в файле `.env.{mode}`.

В рамках этого изменения `vite dev` и `vite build` больше не будут переопределять `process.env.NODE_ENV`, если он уже определен. Поэтому, если вы установили `process.env.NODE_ENV = 'development'` перед сборкой, он также будет собран для разработки. Это дает больше контроля при параллельном запуске нескольких сборок или серверов разработки.

Смотрите обновленную [документацию `mode`](https://vitejs.dev/guide/env-and-mode.html#modes) для получения более подробной информации.

### Переменные среды

Теперь Vite использует `dotenv` 16 и `dotenv-expand` 9 (ранее `dotenv` 14 и `dotenv-expand` 5). Если у вас есть значение, включающее `#` или `` ` ``, вам нужно будет заключить их в кавычки.

```diff
-VITE_APP=ab#cd`ef
+VITE_APP="ab#cd`ef"
```

Для получения дополнительной информации смотрите [`dotenv`](https://github.com/motdotla/dotenv/blob/master/CHANGELOG.md) и [журнал изменений `dotenv-expand`](https://github.com/motdotla/dotenv-expand/blob/master/CHANGELOG.md).

## Продвинутый

Есть некоторые изменения, которые касаются только создателей плагинов/инструментов.

- [[#11036] feat(client)!: удален никогда не реализованный hot.decline](https://github.com/vitejs/vite/issues/11036)
  - вместо этого используйте `hot.invalidate`
- [[#9669] feat: выравнивание интерфейса объекта для хука `transformIndexHtml`](https://github.com/vitejs/vite/issues/9669)
  - используйте `order` вместо `enforce`

Также есть другие критические изменения, которые затрагивают лишь нескольких пользователей.

- [[#11101] feat(ssr)!: убрать поддержку дедупликации и режима для CJS](https://github.com/vitejs/vite/pull/11101)
  - Вам следует перейти на режим ESM по умолчанию для SSR, поддержка CJS SSR может быть удалена в следующем майоре Vite.
- [[#10475] feat: обработка статических ресурсов с учетом регистра](https://github.com/vitejs/vite/pull/10475)
  - Ваш проект не должен полагаться на то, что ОС игнорирует регистр имен файлов.
- [[#10996] fix!: сделано `NODE_ENV` более предсказуемым](https://github.com/vitejs/vite/pull/10996)
  - Обратитесь к PR за объяснением этого изменения.
- [[#10903] refactor(types)!: удалены файлы типов фасада](https://github.com/vitejs/vite/pull/10903)

## Миграция с v2

Сначала проверьте [Руководство по переходу с v2](https://v3.vitejs.dev/guide/migration.html) в документации Vite v3, чтобы увидеть необходимые изменения для переноса вашего приложения на Vite v3, а затем продолжите внесение изменений. на этой странице.
