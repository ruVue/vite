# Исправление проблем

Дополнительную информацию также можно найти в [Руководстве по устранению неполадок Rollup](https://rollupjs.org/troubleshooting/).

Если приведенные здесь предложения не работают, попробуйте опубликовать вопросы в [Обсуждения GitHub](https://github.com/vitejs/vite/discussions) или на канале `#help` в [Vite Land Discord](https://chat.vitejs.dev).

## CLI

### `Error: Cannot find module 'C:\foo\bar&baz\vite\bin\vite.js'`

Путь к папке вашего проекта может включать `&`, что не работает с `npm` в Windows ([npm/cmd-shim#45](https://github.com/npm/cmd-shim/issues/45)).

Вам нужно будет либо:

- Переключитесь на другой менеджер пакетов (например, `pnpm`, `yarn`)
- Удалите `&` из пути к вашему проекту

## Конфиг

### Этот пакет предназначен только для ESM

При импорте пакета только ESM с помощью `require` возникает следующая ошибка.

> Не удалось разрешить «foo». Этот пакет предназначен только для ESM, но его попыталась загрузить с помощью `require`.

> «foo» преобразован в файл ESM. Файл ESM не может быть загружен с помощью `require`.

Файлы ESM не могут быть загружены с помощью [`require`](<https://nodejs.org/docs/latest-v18.x/api/esm.html#require:~:text=Using%20require%20to%20load%20an%20ES%20module%20is%20not%20supported%20because%20ES%20modules%20have%20asynchronous%20execution.%20Instead%2C%20use%20import()%20to%20load%20an%20ES%20module%20from%20a%20CommonJS%20module.>).

Мы рекомендуем преобразовать вашу конфигурацию в ESM одним из следующих способов:

- добавление `"type": "module"` к ближайшему `package.json`
- переименование `vite.config.js`/`vite.config.ts` в `vite.config.mjs`/`vite.config.mts`

## Сервер разработки

### Запросы задерживаются навсегда

Если вы используете Linux, причиной проблемы могут быть ограничения файловых дескрипторов и ограничения inotify. Поскольку Vite не объединяет большинство файлов, браузеры могут запрашивать много файлов, для которых требуется много файловых дескрипторов, что превышает лимит.

Чтобы решить эту проблему:

- Увеличьте лимит дескриптора файла на `ulimit`

  ```shell
  # Check current limit
  $ ulimit -Sn
  # Change limit (temporary)
  $ ulimit -Sn 10000 # You might need to change the hard limit too
  # Restart your browser
  ```

- Увеличьте следующие ограничения, связанные с inotify, с помощью `sysctl`

  ```shell
  # Check current limits
  $ sysctl fs.inotify
  # Change limits (temporary)
  $ sudo sysctl fs.inotify.max_queued_events=16384
  $ sudo sysctl fs.inotify.max_user_instances=8192
  $ sudo sysctl fs.inotify.max_user_watches=524288
  ```

Если описанные выше шаги не сработали, вы можете попробовать добавить `DefaultLimitNOFILE=65536` в качестве незакомментированной конфигурации в следующие файлы:

- /etc/systemd/system.conf
- /etc/systemd/user.conf

Для Ubuntu Linux вам может потребоваться добавить строку `* - nofile 65536` в файл `/etc/security/limits.conf` вместо обновления файлов конфигурации systemd.

Обратите внимание, что эти настройки сохраняются, но **требуется перезагрузка**.

### Сетевые запросы перестают загружаться

При использовании самозаверяющего SSL-сертификата Chrome игнорирует все директивы кэширования и перезагружает содержимое. Vite полагается на эти директивы кэширования.

Чтобы решить эту проблему, используйте доверенный сертификат SSL.

Смотрите: [Проблемы с кэшем](https://helpx.adobe.com/mt/experience-manager/kb/cache-problems-on-chrome-with-SSL-certificate-errors.html), [Chrome issue](https://bugs.chromium.org/p/chromium/issues/detail?id=110649#c8)

#### macOS

Вы можете установить доверенный сертификат через интерфейс командной строки с помощью этой команды:

```
security add-trusted-cert -d -r trustRoot -k ~/Library/Keychains/login.keychain-db your-cert.cer
```

Или импортируйте его в приложение Keychain Access и обновите доверие вашего сертификата до "Always Trust."

### 431 Поля заголовка запроса слишком велики

Когда сервер / сервер WebSocket получает большой HTTP-заголовок, запрос будет отброшен, и будет показано следующее предупреждение.

> Server responded with status code 431. See https://vitejs.ru/guide/troubleshooting.html#_431-request-header-fields-too-large.

Это связано с тем, что Node.js ограничивает размер заголовка запроса для смягчения последствий [CVE-2018-12121](https://www.cve.org/CVERecord?id=CVE-2018-12121).

Чтобы этого избежать, попробуйте уменьшить размер заголовка запроса. Например, если файл cookie длинный, удалите его. Или вы можете использовать [`--max-http-header-size`](https://nodejs.org/api/cli.html#--max-http-header-sizesize), чтобы изменить максимальный размер заголовка.

## HMR

### Vite обнаруживает изменение файла, но HMR не работает

Возможно, вы импортируете файл с другим регистром. Например, `src/foo.js` существует, а `src/bar.js` содержит:

```js
import './Foo.js' // should be './foo.js'
```

Связанная проблема: [#964](https://github.com/vitejs/vite/issues/964)

### Vite не обнаруживает изменение файла

Если вы используете Vite с WSL2, Vite не может отслеживать изменения файлов в некоторых условиях. Смотрите [параметр `server.watch`](/config/server-options.md#server-watch).

### Происходит полная перезагрузка вместо HMR

Если HMR не обрабатывается Vite или плагином, произойдет полная перезагрузка.

Также, если есть цикл зависимости, произойдет полная перезагрузка. Чтобы решить эту проблему, попробуйте удалить цикл.

### Большое количество обновлений HMR в консоли

Это может быть вызвано циклической зависимостью. Чтобы решить эту проблему, попробуйте разорвать цикл.

## Сборка

### Встроенный файл не работает из-за ошибки CORS

Если вывод HTML-файла был открыт с использованием протокола `file`, сценарии не будут запускаться со следующей ошибкой.

> Access to script at 'file:///foo/bar.js' from origin 'null' has been blocked by CORS policy: Cross origin requests are only supported for protocol schemes: http, data, isolated-app, chrome-extension, chrome, https, chrome-untrusted.

> Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at file:///foo/bar.js. (Reason: CORS request not http).

Смотрите [Причина: запрос CORS не HTTP - HTTP | MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSRequestNotHttp) для получения дополнительной информации о том, почему это происходит.

Вам нужно будет получить доступ к файлу по протоколу `http`. Самый простой способ добиться этого — запустить `npx vite preview`.

## Оптимизированные зависимости

### Устаревшие предустановленные пакеты при ссылке на локальный пакет

Хэш-ключ, используемый для аннулирования оптимизированных зависимостей, зависит от содержимого блокировки пакета, исправлений, примененных к зависимостям, и параметров в файле конфигурации Vite, которые влияют на объединение узловых модулей. Это означает, что Vite обнаружит переопределение зависимости с помощью функции [npm overrides](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#overrides) и повторно свяжет ваши зависимости от следующего запуска сервера. Vite не аннулирует зависимости, если вы используете такую функцию, как [ссылка npm](https://docs.npmjs.com/cli/v9/commands/npm-link). В случае, если вы связываете или отключаете зависимость, вам нужно будет принудительно выполнить повторную оптимизацию при следующем запуске сервера, используя `vite --force`. Вместо этого мы рекомендуем использовать переопределения, которые сейчас поддерживаются всеми менеджерами пакетов (см. также [переопределения pnpm](https://pnpm.io/package_json#pnpmoverrides) и [yarn резолюции](https://yarnpkg.com/configuration/manifest/#resolutions)).

## Другие

### Модуль вынесен наружу для совместимости с браузером

Когда вы используете модуль Node.js в браузере, Vite выведет следующее предупреждение.

> Модуль «fs» вынесен наружу для совместимости с браузером. Невозможно получить доступ к «fs.readFile» в клиентском коде.

Это связано с тем, что Vite не выполняет автоматическое заполнение модулей Node.js.

Мы рекомендуем избегать модулей Node.js для кода браузера, чтобы уменьшить размер пакета, хотя вы можете добавлять полифилы вручную. Если модуль импортирован из сторонней библиотеки (которая предназначена для использования в браузере), рекомендуется сообщить о проблеме в соответствующую библиотеку.

### Синтаксическая ошибка / Ошибка типа

Vite не может обрабатывать и не поддерживает код, который работает только в нестрогом режиме (небрежный режим). Это связано с тем, что Vite использует ESM и всегда [строгий режим](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode) внутри ESM.

Например, вы можете увидеть эти ошибки.

> [ОШИБКА] Операторы With нельзя использовать с форматом вывода «esm» из-за строгого режима.

> Ошибка типа: невозможно создать свойство «foo» для логического значения «false».

Если этот код используется внутри зависимостей, вы можете использовать [`patch-package`](https://github.com/ds300/patch-package) (или [`yarn patch`](https://yarnpkg.com/cli/patch) или [`pnpm patch`](https://pnpm.io/cli/patch)) для аварийного hatch.

### Расширения браузера

Некоторые расширения браузера (например, блокировщики рекламы) могут препятствовать отправке клиентом Vite запросов на сервер разработки Vite. В этом случае вы можете увидеть белый экран без зарегистрированных ошибок. Попробуйте отключить расширения, если у вас возникла эта проблема.

### Перекрестные ссылки в Windows

Если в вашем проекте в Windows есть перекрестные ссылки, Vite может не работать.

Пример перекрестных ссылок:

- виртуальный диск, связанный с папкой командой `subst`
- символическая ссылка/переход на другой диск с помощью команды `mklink` (например, глобальный кеш Yarn)

Связанная проблема: [#10802](https://github.com/vitejs/vite/issues/10802)
